<!DOCTYPE html>
<html lang="en" class="nowhitespace">
	<head>
		<meta name="description" content="Beam editor for show lasers.">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Beat alignment</title>
		<link rel="stylesheet" href="./svgtest.css" />
	</head>
	<body>
        <h3>wavedisplay.js</h3>
        <div class="sliderbar" id="zoomDiv"><label>Zoom</label><input type="range" min="1" max="3000" value="1" step="0.001"></input></div>
        <div class="sliderbar" id="scaleDiv"><label>Scale</label><input type="range" min="0" max="10" value="1" step="0.001"></input></div>
        <div id="container"></div>
        <div id="info">
            <li>Use mouse wheel to zoom to target or slider.</li>
            <li>Scroll bar or drag the wave form itself.</li>
            <li>Swipe the waveform. It has inertia.</li>
            <li>Touch screen and multitouch to adjust zoom.</li>
        </div>
        <div id="logHeader"><span>Log</span><a href="#" onClick="document.querySelector('#log').innerHTML = '';">clear</a></div>
        <div id = "log"></div>
        <script type="module">
            import {WaveDisplay} from './wavedisplay.js';

            // Set up audio context
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioContext = new AudioContext();

            // Get the audio data
            fetch('I_have_been_waiting_for_you.mp3')
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(audioBuffer => {
                    let zoom = document.querySelector('#zoomDiv input');

                    // Create the UI to display the waveform
                    let waveDisplay = new WaveDisplay({
                        data: audioBuffer.getChannelData(0),
                        parent: document.querySelector('#container'),
                        samplesPerPoint: 600,
                        sampleRate: audioBuffer.sampleRate,
                        decelerationTime: 4,
                        zoomRate: 0.1,
                        zeroIsMiddle: false,
                        zoom: 2,
                    });

                    waveDisplay.onViewChange = ()=>{
                        zoom.value = waveDisplay.zoom;
                    }

                    window.addEventListener("resize", (event) => {
                        document.querySelector('#zoom').setAttribute('max', waveDisplay.maxZoom);
                    });

                    window['waveDisplay'] = waveDisplay;

                    // A way to implement an external zoom command
                    
                    zoom.setAttribute('max', waveDisplay.maxZoom);
                    zoom.addEventListener('input', (e)=>{
                        waveDisplay.zoom = Number(e.target.value);
                    });
                
                    let scale = document.querySelector('#scaleDiv input');
                    scale.addEventListener('input', (e)=>{
                        waveDisplay.scale = Number(e.target.value);
                    });   

                    // A way to obtain a time in seconds in the wave form.
                    document.querySelector('#container').addEventListener('pointerdown', (e)=>{
                        //console.log('Time in seconds: ' + waveDisplay.getSeconds(e.clientX));
                        //console.log('index: ' + waveDisplay.getIndex(e.clientX));
                        //console.log('startIndex: ' + waveDisplay.startIndex, 'endIndex: ' + waveDisplay.endIndex)
                    }, { passive: false });
                });



            //  Just some handy onscreen logging for mobile touch devices 
            if (typeof console  != "undefined") 
            if (typeof console.log != 'undefined')
                console.olog = console.log;
            else
                console.olog = function() {};
            
            var logDiv = document.querySelector('#log');

            console.log = function(message, lineId='') {
                console.olog(message);
                let messageHandled = false;
                if (lineId != ''){
                    let lineElm = logDiv.querySelector('#'+lineId);
                    if (lineElm){
                        lineElm.innerText = message;
                        messageHandled = true;
                    } else {
                        logDiv.insertAdjacentHTML('beforeEnd', '<div id="'+lineId+'">' + message + '</div>');
                    }
                } else {
                    logDiv.insertAdjacentHTML('beforeEnd', '<div>' + message + '</div>');
                }
            };
            console.error = console.debug = console.info =  console.log
        </script>
    </body>
</html>
